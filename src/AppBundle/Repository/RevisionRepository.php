<?php

namespace AppBundle\Repository;

use AppBundle\Libs\Normalizer\ResultDecorator;
use AppBundle\Libs\Repository\BaseRepository;
use Doctrine\ORM\EntityRepository;

/**
 * RevisionsRepository
 *
 * @author Yosviel Dominguez <yosvield@gmail.com>
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class RevisionRepository extends BaseRepository {

    public function getBaseQuery($baseEntity, $start = 0, $limit = 30, $filters = array(), $columnsAlias = array(), $decorator = ResultDecorator::DEFAULT_DECORATOR) {

    }

    /**
     * @author Yosviel Dominguez <yosvield@gmail.com>
     * @param $idpermittype
     * @return array
     */
    public function getByPermitType($idpermittype){
        $qb = $this->createQueryBuilder('revision')
            ->innerJoin('revision.permitType', 'permitType')
            ->andWhere("permitType.id = (:idpermittype)")
            ->setParameter('idpermittype', $idpermittype);

        return $qb->getQuery()->getResult();
    }

    /**
     * Para listar el select cuando se gestionar las revision, excluyendo los que tiene seleccionado
     * @author Yosviel Dominguez <yosvield@gmail.com>
     * @param $idpermittype
     * @return array
     */
    public function getByPermitTypeExcludePermit($idpermittype, $idpermit){
        $qb1 = $this->createQueryBuilder('revision')
            ->select('revision.id')
            ->innerJoin('revision.permitRevisions', 'permitRevisions')
            ->innerJoin('permitRevisions.permitpermittype', 'permitpermittype')
            ->innerJoin('permitpermittype.permit', 'permit')
            ->andWhere("permit.id = (:idpermit)")
            ->setParameter('idpermit', $idpermit);

        $idsRevisionOfPermit = $qb1->getQuery()->getResult();

        $qb = $this->createQueryBuilder('revision')
            ->innerJoin('revision.permitType', 'permitType')
            ->andWhere("revision.id not in (:ids)")
            ->andWhere("permitType.id = (:idpermittype)")
            ->setParameter('ids', $idsRevisionOfPermit)
            ->setParameter('idpermittype', $idpermittype);

        return $qb->getQuery()->getResult();
    }
}
